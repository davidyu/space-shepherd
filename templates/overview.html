<html>
<head>
  <style>
    .node {
      border: solid 1px black;
      font: 10px sans-serif;
      line-height: 12px;
      overflow: hidden;
      position: absolute;
      text-indent: 2px;
    }

    .folder {
      /* subtle thin pixel bevel edge */
      box-shadow:
        rgba(256,256,256,0.35)
        0px 1px 0 /* topmost pixel only */
        0px /* spread */
        inset;
      white-space: nowrap;
    }

    .d3-tip {
      font: 10px sans-serif;
      line-height: 1;
      padding: 12px;
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      border-radius: 2px;
    }

    .hidden-node {
      display: none;
    }
    
    body {
      margin: 0;
    }
  </style>
  <title>Space Shepherd - {{ username }}</title>
  <script src="/static/vendor/d3.js" type="text/javascript"></script>
  <script>
        // http://stackoverflow.com/a/14919494
        function humanFileSize(bytes, si) {
            var thresh = si ? 1000 : 1024;
            if(Math.abs(bytes) < thresh) {
                return bytes + ' B';
            }
            var units = ['kB','MB','GB','TB','PB','EB','ZB','YB'];
            var u = -1;
            do {
                bytes /= thresh;
                ++u;
            } while(Math.abs(bytes) >= thresh && u < units.length - 1);
            return bytes.toFixed(1)+' '+units[u];
        }

        // http://stackoverflow.com/a/2035211
        function getViewport() {
            var viewPortWidth;
            var viewPortHeight;

            if (typeof window.innerWidth != 'undefined') {
                viewPortWidth = window.innerWidth,
                viewPortHeight = window.innerHeight
            } else if ( typeof document.documentElement != 'undefined' &&
                        typeof document.documentElement.clientWidth != 'undefined' &&
                        document.documentElement.clientWidth != 0 ) {
                // IE6 in standards compliant mode
                viewPortWidth = document.documentElement.clientWidth,
                viewPortHeight = document.documentElement.clientHeight
            } else {
                // le sigh...
                viewPortWidth = document.getElementsByTagName('body')[0].clientWidth,
                viewPortHeight = document.getElementsByTagName('body')[0].clientHeight
            }
            return { w: viewPortWidth, h: viewPortHeight };
        }

        var viewport = getViewport();

        var margin = {top: 100, right: 20, bottom: 20, left: 20},
            width  = viewport.w - margin.left - margin.right,
            height = viewport.h - margin.top - margin.bottom;

        // generated via http://colorbrewer2.org/ 
        var color = d3.scale.ordinal().range(['#fbb4ae','#b3cde3','#ccebc5','#decbe4','#fed9a6','#ffffcc','#8dd3c7','#ffffb3','#bebada','#fb8072','#80b1d3','#fdb462','#b3de69','#fccde5','#d9d9d9','#bc80bd','#ccebc5','#ffed6f']);

        var treemap = d3.layout.treemap()
                        .size([width, height])
                        .padding([15,5,5,5])
                        .sort(function(a,b) { return a.size - b.size; }) // big to small
                        .value(function(d) { return d.size; });

        var maxdepth = 3;
        var curdepth = 0;

        var filetree = null;
        var div = null;
        var tooltip = null;

        function percentageOfOccupiedSpace(node) {
            return (node.size * 100 / filetree.size).toFixed(1) + '% of total occupied space';
        }

        function isRoot(node) {
            return node.name == '/';
        }

        function updateAndShowToolTip(node) {
            return tooltip.html(node.name + "<br/>" + humanFileSize(node.size) + "<br/>" + (isRoot(node) ? "Root" : percentageOfOccupiedSpace(node)) + "<br/>" + ( node.is_dir ? "Folder<br/>" : "" ) )
                          .style("visibility", "visible");
        }
        
        function moveToolTip() {
            return tooltip.style("top", (event.pageY-10) + "px").style("left",(event.pageX+10) + "px");
        }

        function start() {
          div = d3.select("#canvas")
                  .style("position", "absolute")
                  .style("width", width + "px")
                  .style("height", height + "px")
                  .style("left", margin.left + "px")
                  .style("top", margin.top + "px");

          d3.json("/get_filetree", function(error, tree) {
            if (error) throw error;
            filetree = tree;
            draw_tree(tree);
          });

          tooltip = d3.select("body")
              .append("div")
              .style("position", "absolute")
              .style("z-index", "10")
              .style("visibility", "hidden")
              .attr("class", "d3-tip")

          window.setInterval( poll, 3000 );
        }

        function position() {
          this.style("left", function(d) { return d.x + "px"; })
              .style("top", function(d) { return d.y + "px"; })
              .style("width", function(d) { return Math.max(0, d.dx - 1) + "px"; })
              .style("height", function(d) { return Math.max(0, d.dy - 1) + "px"; });
        }

        function tooSmall(node) {
            return node.dx < 3 || node.dy < 3 || node.dx * node.dy < 10;
        }

        function enoughRoomForFileName(node) {
            return node.dx > 30 && node.dy > 18;
        }

        function computeClass(node) {
            if (tooSmall(node) || node.depth > maxdepth) {
                return "hidden-node";
            } else if (node.is_dir) {
                return "folder node"
            } else {
                return "node";
            }
        }

        treemap_node = null;

        function draw_tree(root) {
            treemap_node = div.datum(root).selectAll(".node")
              .data(treemap.nodes, function(d) {return d.path;});

            treemap_node
              .enter().append("div")
              .attr("class", computeClass)
              .call(position)
              .style("background", function(d) { return color(d.depth); })
              .text(function(d) { return enoughRoomForFileName(d) ? d.name : null; })
              .on("mouseover", updateAndShowToolTip)
              .on("mousemove", moveToolTip)
              .on("mouseout", function(){return tooltip.style("visibility", "hidden");});
        }

        function update_tree(root) {
            treemap_node = div.datum(root).selectAll(".node")
              .data(treemap.nodes, function(d) {return d.path;});

            treemap_node
              .enter().append("div")
              .attr("class", computeClass)
              .call(position)
              .style("background", function(d) { return color(d.depth); })
              .text(function(d) { return enoughRoomForFileName(d) ? d.name : null; })
              .on("mouseover", updateAndShowToolTip)
              .on("mousemove", moveToolTip)
              .on("mouseout", function(){return tooltip.style("visibility", "hidden");});

            treemap_node
               .exit().remove();

            treemap_node
              .attr("class", computeClass)
              .call(position)
              .text(function(d) { return enoughRoomForFileName(d) ? d.name : null; })
        }

        var waitingForPollResponse = false;
        function poll() {
            if ( waitingForPollResponse ) return;
            waitingForPollResponse = true;
            d3.json("/update_filetree", function(error, data) {
                waitingForPollResponse = false;
                if (error) throw error;
                if (data.changed) {
                    filetree = data.tree;
                    update_tree(data.tree);
                }
            });
        }
  </script>
</head>
<body onload="start()">
  <div class="main-container">
      <p>{{username}}'s Dropbox</p>
      <div id="canvas">
      </div>
  </div>
  </body>
</html>
