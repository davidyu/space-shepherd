<html>
<head>
  <style>
    .node {
      border: solid 1px black;
      font: 10px sans-serif;
      line-height: 12px;
      overflow: hidden;
      position: absolute;
      text-indent: 2px;
    }

    .folder {
      /* subtle thin pixel bevel edge */
      box-shadow:
        rgba(256,256,256,0.35)
        0px 1px 0 /* topmost pixel only */
        0px /* spread */
        inset;
      white-space: nowrap;
    }

    .hidden-node {
      display: none;
    }

    body {
      margin: 0;
    }
  </style>
  <title>Space Shepherd - {{ username }}</title>
  <script src="/static/vendor/d3.js" type="text/javascript"></script>
  <script>
        // http://stackoverflow.com/a/2035211
        function getViewport() {
            var viewPortWidth;
            var viewPortHeight;

            if (typeof window.innerWidth != 'undefined') {
                viewPortWidth = window.innerWidth,
                viewPortHeight = window.innerHeight
            } else if ( typeof document.documentElement != 'undefined' &&
                        typeof document.documentElement.clientWidth != 'undefined' &&
                        document.documentElement.clientWidth != 0 ) {
                // IE6 in standards compliant mode
                viewPortWidth = document.documentElement.clientWidth,
                viewPortHeight = document.documentElement.clientHeight
            } else {
                // le sigh...
                viewPortWidth = document.getElementsByTagName('body')[0].clientWidth,
                viewPortHeight = document.getElementsByTagName('body')[0].clientHeight
            }
            return { w: viewPortWidth, h: viewPortHeight };
        }

        var viewport = getViewport();

        var margin = {top: 100, right: 20, bottom: 20, left: 20},
            width  = viewport.w - margin.left - margin.right,
            height = viewport.h - margin.top - margin.bottom;

        // generated via http://colorbrewer2.org/ 
        var color = d3.scale.ordinal().range(['#fbb4ae','#b3cde3','#ccebc5','#decbe4','#fed9a6','#ffffcc','#8dd3c7','#ffffb3','#bebada','#fb8072','#80b1d3','#fdb462','#b3de69','#fccde5','#d9d9d9','#bc80bd','#ccebc5','#ffed6f']);

        var treemap = d3.layout.treemap()
                        .size([width, height])
                        .padding([15,5,5,5])
                        .sort(function(a,b) { return a.size - b.size; }) // big to small
                        .sticky(true)
                        .value(function(d) { return d.size; });

        var maxdepth = 3;
        var curdepth = 0;

        var div = null;

        function start() {
          div = d3.select("#canvas")
                  .style("position", "absolute")
                  .style("width", width + "px")
                  .style("height", height + "px")
                  .style("left", margin.left + "px")
                  .style("top", margin.top + "px");

          d3.json("/get_filetree", function(error, tree) {
            if (error) throw error;
            draw_tree(tree);
          });
        }

        function position() {
          this.style("left", function(d) { return d.x + "px"; })
              .style("top", function(d) { return d.y + "px"; })
              .style("width", function(d) { return Math.max(0, d.dx - 1) + "px"; })
              .style("height", function(d) { return Math.max(0, d.dy - 1) + "px"; });
        }

        function tooSmall(node) {
            return node.dx < 3 || node.dy < 3 || node.dx * node.dy < 10;
        }

        function enoughRoomForFileName(node) {
            return node.dx > 30 && node.dy > 18;
        }

        function computeClass(node) {
            if (tooSmall(node) || node.depth > maxdepth) {
                return "hidden-node";
            } else if (node.is_dir) {
                return "folder node"
            } else {
                return "node";
            }
        }

        function draw_tree(root) {
          var node = div.datum(root).selectAll(".node")
              .data(treemap.nodes)
              .enter().append("div")
              .attr("class", function(d) { return computeClass(d); } )
              .call(position)
              .style("background", function(d) { return color(d.depth); })
              .text(function(d) { return enoughRoomForFileName(d) ? d.name : null; });

          d3.selectAll("input").on("change", function change() {
            var value = this.value === "count"
                ? function() { return 1; }
                : function(d) { return d.size; };

            node
                .data(treemap.value(value).nodes)
                .transition()
                .duration(1500)
                .call(position);

            node.exit().remove();
          });
        }

        function update() {
            d3.json("/update_filetree", function(error, data) {
              if (error) throw error;
              if (data.changed) draw_tree(data.tree);
            });
        }
  </script>
</head>
<body onload="start()">
  <div class="main-container">
      <p>{{username}}'s Dropbox</p>
      <div id="canvas">
      </div>
  </div>
  </body>
</html>
